<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flappy Bird Reforged</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï --- */
        :root {
            --font-main: 'Nunito', sans-serif;
            --bg-color: #4EC0CA;
            --panel-bg: #FDFDFF;
            --text-dark: #3B3B3B;
            --text-light: #FFFFFF;
            --primary-color: #FFC93C;
            --primary-shadow: #E6A100;
            --secondary-color: #6AD7E2;
            --secondary-shadow: #46B6C2;
            --danger-color: #FF5A5F;
            --danger-shadow: #D9363B;
            --panel-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            --border-radius-md: 16px;
            --border-radius-lg: 24px;
            --transition: 0.2s ease-out;
        }

        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: var(--bg-color);
            overflow: hidden;
            font-family: var(--font-main);
            /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        canvas {
            border: 4px solid #FFFFFF;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--panel-shadow);
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* --- –°–¢–ò–õ–ò –ü–ê–ù–ï–õ–ï–ô –ò –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù --- */
        .panel {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--panel-bg);
            border: 4px solid var(--text-light);
            padding: 25px;
            text-align: center;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--panel-shadow);
            width: 90%;
            max-width: 380px;
            box-sizing: border-box;
        }

        .panel h1, .panel h2 {
            font-size: clamp(2.5rem, 8vw, 3.5rem);
            color: var(--text-dark);
            margin: 0 0 20px 0;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }
        
        #gameOverPanel h2 {
            color: var(--danger-color);
        }

        .panel p {
            font-size: 1.2rem;
            color: var(--text-dark);
            font-weight: 700;
            margin: 10px 0;
        }

        /* --- –°–¢–ò–õ–ò –ö–ù–û–ü–û–ö --- */
        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .button {
            width: 100%;
            padding: 15px 20px;
            background-color: var(--primary-color);
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-dark);
            transition: all var(--transition);
            border-bottom: 6px solid var(--primary-shadow);
            text-transform: uppercase;
        }

        .button:hover {
            filter: brightness(1.05);
        }
        .button:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
        }

        /* –í–∞—Ä–∏–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ */
        #mediumBtn { background-color: var(--secondary-color); border-bottom-color: var(--secondary-shadow); }
        #hardBtn { background-color: var(--danger-color); border-bottom-color: var(--danger-shadow); color: var(--text-light); }
        #earnButton, .coin-package { background-color: #2ECC71; border-bottom-color: #25A25A; color: var(--text-light); }
        
        .icon-buttons-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }

        .icon-button {
            width: 60px;
            height: 60px;
            background-color: #E8E8E8;
            border: none;
            border-radius: var(--border-radius-md);
            background-size: 60%;
            background-repeat: no-repeat;
            background-position: center;
            border-bottom: 6px solid #C4C4C4;
        }
        .icon-button:active { transform: translateY(4px); border-bottom-width: 2px; }

        #shopBtn { background-image: url('https://i.imgur.com/8a1Z9Q7.png'); } /* Shop Icon */
        #statsBtn { background-image: url('https://i.imgur.com/2Y0fB53.png'); } /* Stats Icon */
        #infoBtn { background-image: url('https://i.imgur.com/wVf7Y7V.png'); } /* Info Icon */
        #restartBtn {
            font-size: 2rem;
            width: 80px !important;
            height: 80px;
            background-color: var(--primary-color);
            border-bottom-color: var(--primary-shadow);
        }
        #menuBtn {
            width: calc(100% - 100px);
            background-color: #E8E8E8;
            border-bottom-color: #C4C4C4;
        }

        /* --- –ú–ê–ì–ê–ó–ò–ù –ò –í–ö–õ–ê–î–ö–ò --- */
        #shopPanel { padding-bottom: 80px; } /* –ú–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å" */

        .tabs {
            display: flex;
            margin-bottom: 15px;
            background-color: #E8E8E8;
            border-radius: var(--border-radius-md);
            padding: 5px;
        }
        .tab-button {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 800;
            color: #8A8A8A;
            transition: all var(--transition);
        }
        .tab-button.active {
            background: var(--text-light);
            color: var(--text-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
        }

        .shop-item {
            aspect-ratio: 1;
            background-color: #F0F0F0;
            border-radius: var(--border-radius-md);
            padding: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            border: 4px solid transparent;
            transition: all var(--transition);
        }
        .shop-item:hover { transform: translateY(-5px); }
        .shop-item.selected { border-color: var(--primary-color); }
        .shop-item.locked::after {
            content: 'üîí';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0; left: 0;
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            color: white;
            font-size: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .shop-item img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }
        #backgroundsTab .shop-item img { object-fit: cover; border-radius: 10px; }
        .shop-item p {
            font-size: 0.9rem;
            font-weight: 900;
            margin: 0;
            color: var(--text-dark);
        }
        .shop-item p .coin-icon { font-size: 0.8em; }

        /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ó–∞–∫—Ä—ã—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ */
        .close-button-wrapper {
            position: absolute;
            bottom: 25px;
            left: 25px;
            right: 25px;
        }

        /* –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò –ò–ù–§–û */
        .stats-content, .info-content {
            text-align: left;
            margin: 20px 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <div id="mainMenu" class="panel">
        <h1>Flappy Bird</h1>
        <div id="coinDisplay" style="font-size: 1.5rem; font-weight: 800; margin-bottom: 20px;">0 üí∞</div>
        <div class="button-container">
            <button id="easyBtn" class="button">–õ–µ–≥–∫–æ</button>
            <button id="mediumBtn" class="button">–°—Ä–µ–¥–Ω–µ</button>
            <button id="hardBtn" class="button">–°–ª–æ–∂–Ω–æ</button>
            <div class="icon-buttons-row">
                <button id="shopBtn" class="icon-button"></button>
                <button id="statsBtn" class="icon-button"></button>
                <button id="infoBtn" class="icon-button"></button>
            </div>
            <button id="earnButton" class="button">100 üí∞ –∑–∞ —Ä–µ–∫–ª–∞–º—É</button>
        </div>
    </div>

    <div id="gameOverPanel" class="panel">
        <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</h2>
        <p>–°—á–µ—Ç: <span id="scoreDisplay"></span></p>
        <p>–†–µ–∫–æ—Ä–¥: <span id="highScoreDisplay"></span></p>
        <p>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span id="coinsDisplay"></span></p>
        <div class="icon-buttons-row" style="margin: 20px 0;">
            <button id="restartBtn" class="button">&#8635;</button>
            <button id="menuBtn" class="button">–ú–µ–Ω—é</button>
        </div>
        <button id="shareBtn" class="button" style="width: 100%;">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>

    <div id="shopPanel" class="panel">
        <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div class="tabs">
            <button class="tab-button active" data-tab="birds">–ü—Ç–∏—á–∫–∏</button>
            <button class="tab-button" data-tab="backgrounds">–§–æ–Ω—ã</button>
        </div>
        <div id="birdsTab" class="tab-content active">
            <div class="shop-grid">
                </div>
        </div>
        <div id="backgroundsTab" class="tab-content">
            <div class="shop-grid">
                </div>
        </div>
        <div class="close-button-wrapper">
             <button id="coinsBtn" class="button" style="margin-bottom: 10px;">–ö—É–ø–∏—Ç—å –º–æ–Ω–µ—Ç—ã</button>
             <button id="closeShopBtn" class="button" style="background: #E8E8E8; border-bottom-color: #C4C4C4;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="statsPanel" class="panel">
         <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
         <div class="stats-content">
             <p><strong>–†–µ–∫–æ—Ä–¥—ã:</strong></p>
             <div>–õ–µ–≥–∫–∏–π: <span id="easyStats">0</span></div>
             <div>–°—Ä–µ–¥–Ω–∏–π: <span id="mediumStats">0</span></div>
             <div>–°–ª–æ–∂–Ω—ã–π: <span id="hardStats">0</span></div>
         </div>
         <button id="closeStatsBtn" class="button">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <div id="infoPanel" class="panel">
         <h2>–û –∏–≥—Ä–µ</h2>
         <div class="info-content">
            <p><strong>–ù–∞–≥—Ä–∞–¥—ã –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ:</strong></p>
            <div><strong>–õ–µ–≥–∫–∏–π:</strong> 1<span class="coin-icon">üí∞</span> –∑–∞ 15 —Ç—Ä—É–±</div>
            <div><strong>–°—Ä–µ–¥–Ω–∏–π:</strong> 1<span class="coin-icon">üí∞</span> –∑–∞ 10 —Ç—Ä—É–±</div>
            <div><strong>–°–ª–æ–∂–Ω—ã–π:</strong> 1<span class="coin-icon">üí∞</span> –∑–∞ 5 —Ç—Ä—É–±</div>
         </div>
         <button id="closeInfoBtn" class="button">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="coinsPanel" class="panel">
        <h2>–ö—É–ø–∏—Ç—å –º–æ–Ω–µ—Ç—ã</h2>
        <div class="button-container">
            <button class="coin-package button" data-item="coins_100">100 üí∞</button>
            <button class="coin-package button" data-item="coins_300">300 üí∞</button>
            <button class="coin-package button" data-item="coins_500">500 üí∞</button>
            <button class="coin-package button" data-item="coins_1000">1000 üí∞</button>
        </div>
        <button id="closeCoinsBtn" class="button" style="background: #E8E8E8; border-bottom-color: #C4C4C4; margin-top: 20px;">–ù–∞–∑–∞–¥</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø VK BRIDGE ---
        let vkUser = null;
        try {
            await vkBridge.send('VKWebAppInit');
            vkUser = await vkBridge.send('VKWebAppGetUserInfo');
            console.log('VK Bridge Initialized. User:', vkUser);
        } catch (error) {
            console.warn('VK Bridge failed. Running in guest mode.', error);
        }

        // --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400;
        canvas.height = 600;

        const dom = {
            mainMenu: document.getElementById('mainMenu'),
            gameOverPanel: document.getElementById('gameOverPanel'),
            shopPanel: document.getElementById('shopPanel'),
            statsPanel: document.getElementById('statsPanel'),
            infoPanel: document.getElementById('infoPanel'),
            coinsPanel: document.getElementById('coinsPanel'),
            // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ DOM —ç–ª–µ–º–µ–Ω—Ç—ã)
        };
        
        const BIRD_COUNT = 12;
        const BACKGROUND_COUNT = 12;

        const gameConfig = {
            SPEED_EASY: 4, SPEED_MEDIUM: 6, SPEED_HARD: 7,
            GAP_EASY: 250, GAP_MEDIUM: 200, GAP_HARD: 200,
            PIPE_WIDTH: 50,
            HOLE_SPEED: 1.5
        };

        const birdPhysics = { GRAVITY: 0.7, LIFT: -11, ROTATION_SPEED: 0.1 };

        let state = {
            bird: { x: 50, y: 150, width: 45, height: 35, velocity: 0, angle: 0 },
            pipes: [],
            score: 0,
            coinsEarned: 0,
            pipeSpeed: 0,
            gap: 0,
            isGameOver: false,
            isPaused: false,
            currentDifficulty: 'easy',
            lastTime: 0,
            pipeTimer: 0
        };

        let playerProgress = {
            highScores: { easy: 0, medium: 0, hard: 0 },
            totalCoins: 0,
            selectedBirdIndex: 0,
            selectedBackgroundIndex: 0,
            unlockedBirds: [0],
            unlockedBackgrounds: [0]
        };

        // --- –ó–ê–ì–†–£–ó–ö–ê –†–ï–°–£–†–°–û–í ---
        const birdImages = Array(BIRD_COUNT).fill().map((_, i) => { const img = new Image(); img.src = `https://i.imgur.com/g8eL7hV.png`; return img; });
        const backgroundImages = Array(BACKGROUND_COUNT).fill().map((_, i) => { const img = new Image(); img.src = `https://i.imgur.com/Obgx2Jr.png`; return img; });

        // --- –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø/–ó–ê–ì–†–£–ó–ö–ò VK ---
        async function saveGameProgress() {
            if (!vkUser) return;
            const storageKey = `flappy_reforged_${vkUser.id}`;
            try {
                await vkBridge.send('VKWebAppStorageSet', { key: storageKey, value: JSON.stringify(playerProgress) });
            } catch (e) {
                localStorage.setItem(storageKey, JSON.stringify(playerProgress));
            }
        }

        async function loadGameProgress() {
            if (!vkUser) return;
            const storageKey = `flappy_reforged_${vkUser.id}`;
            try {
                const response = await vkBridge.send('VKWebAppStorageGet', { keys: [storageKey] });
                if (response.keys[0]?.value) {
                    const loadedData = JSON.parse(response.keys[0].value);
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º, —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ playerProgress –Ω–µ –∑–∞—Ç–∏—Ä–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–º–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è–º–∏
                    playerProgress = {...playerProgress, ...loadedData};
                }
            } catch (e) {
                const localData = localStorage.getItem(storageKey);
                if (localData) playerProgress = {...playerProgress, ...JSON.parse(localData)};
            }
        }
        
        // --- –õ–û–ì–ò–ö–ê –ü–õ–ê–¢–ï–ñ–ï–ô VK ---
        async function buyCoins(item) {
            try {
                // `item` - —ç—Ç–æ ID —Ç–æ–≤–∞—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                const result = await vkBridge.send('VKWebAppShowOrderBox', { type: 'item', item: item });
                if (result.status === 'success') {
                    const coinsToAdd = parseInt(item.split('_')[1]);
                    playerProgress.totalCoins += coinsToAdd;
                    updateCoinDisplay();
                    await saveGameProgress();
                    alert(`–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ ${coinsToAdd} –º–æ–Ω–µ—Ç!`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –≤–∫–ª—é—á–µ–Ω—ã –ø–ª–∞—Ç–µ–∂–∏.');
            }
        }

        // --- –û–°–ù–û–í–ù–û–ô –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ---
        function gameLoop(timestamp) {
            if (state.isGameOver || state.isPaused) return;
            
            const deltaTime = (timestamp - (state.lastTime || timestamp)) / 1000;
            state.lastTime = timestamp;

            update(deltaTime);
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            // –§–∏–∑–∏–∫–∞ –ø—Ç–∏—Ü—ã
            state.bird.velocity += birdPhysics.GRAVITY;
            state.bird.y += state.bird.velocity;
            state.bird.angle = Math.min(Math.max(state.bird.velocity / 15, -Math.PI/4), Math.PI/2);
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –¥–≤–∏–∂–µ–Ω–∏–µ —Ç—Ä—É–±
            state.pipeTimer += dt;
            const spawnInterval = 1.5 * (gameConfig.SPEED_EASY / state.pipeSpeed);
            if (state.pipeTimer > spawnInterval) {
                addPipe();
                state.pipeTimer = 0;
            }
            
            state.pipes.forEach(pipe => {
                pipe.top.x -= state.pipeSpeed;
                pipe.bottom.x -= state.pipeSpeed;
                // –î–≤–∏–∂–µ–Ω–∏–µ —Ç—Ä—É–± –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –Ω–∞ —Å–ª–æ–∂–Ω–æ–º —É—Ä–æ–≤–Ω–µ
                if (state.currentDifficulty === 'hard') {
                    pipe.offsetY += pipe.direction * gameConfig.HOLE_SPEED;
                    if (Math.abs(pipe.offsetY) > 50) pipe.direction *= -1;
                    pipe.top.height = pipe.baseY + pipe.offsetY;
                    pipe.bottom.y = pipe.top.height + state.gap;
                }
            });

            state.pipes = state.pipes.filter(pipe => pipe.top.x + gameConfig.PIPE_WIDTH > 0);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π –∏ —Å—á–µ—Ç–∞
            const passedPipe = state.pipes.find(p => p.top.x + gameConfig.PIPE_WIDTH < state.bird.x && !p.passed);
            if (passedPipe) {
                passedPipe.passed = true;
                state.score++;
                updateCoins();
            }

            if (checkCollision()) {
                endGame();
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // –§–æ–Ω
            ctx.drawImage(backgroundImages[playerProgress.selectedBackgroundIndex], 0, 0, canvas.width, canvas.height);
            // –¢—Ä—É–±—ã
            state.pipes.forEach(pipe => {
                ctx.fillStyle = '#73BF2E';
                ctx.fillRect(pipe.top.x, 0, gameConfig.PIPE_WIDTH, pipe.top.height);
                ctx.fillRect(pipe.bottom.x, pipe.bottom.y, gameConfig.PIPE_WIDTH, canvas.height - pipe.bottom.y);
            });
            // –ü—Ç–∏—Ü–∞
            ctx.save();
            ctx.translate(state.bird.x + state.bird.width / 2, state.bird.y + state.bird.height / 2);
            ctx.rotate(state.bird.angle);
            ctx.drawImage(birdImages[playerProgress.selectedBirdIndex], -state.bird.width / 2, -state.bird.height / 2, state.bird.width, state.bird.height);
            ctx.restore();
            // –°—á–µ—Ç
            ctx.fillStyle = 'white';
            ctx.font = '45px ' + 'Nunito';
            ctx.textAlign = 'center';
            ctx.fillText(state.score, canvas.width / 2, 70);
            ctx.strokeText(state.score, canvas.width / 2, 70);
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function startGame(difficulty) {
            state.currentDifficulty = difficulty;
            switch(difficulty) {
                case 'easy': state.pipeSpeed = gameConfig.SPEED_EASY; state.gap = gameConfig.GAP_EASY; break;
                case 'medium': state.pipeSpeed = gameConfig.SPEED_MEDIUM; state.gap = gameConfig.GAP_MEDIUM; break;
                case 'hard': state.pipeSpeed = gameConfig.SPEED_HARD; state.gap = gameConfig.GAP_HARD; break;
            }
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            Object.assign(state, {
                bird: { ...state.bird, y: 150, velocity: 0, angle: 0 },
                pipes: [], score: 0, coinsEarned: 0, isGameOver: false, isPaused: false, lastTime: 0, pipeTimer: 0
            });
            
            hideAllPanels();
            requestAnimationFrame(gameLoop);
        }

        function endGame() {
            state.isGameOver = true;
            playerProgress.totalCoins += state.coinsEarned;
            if (state.score > playerProgress.highScores[state.currentDifficulty]) {
                playerProgress.highScores[state.currentDifficulty] = state.score;
            }
            saveGameProgress();

            document.getElementById('scoreDisplay').innerText = state.score;
            document.getElementById('highScoreDisplay').innerText = playerProgress.highScores[state.currentDifficulty];
            document.getElementById('coinsDisplay').innerText = `+${state.coinsEarned} üí∞`;
            dom.gameOverPanel.style.display = 'block';
        }

        function checkCollision() {
            if (state.bird.y <= 0 || state.bird.y + state.bird.height >= canvas.height) {
                return true;
            }
            for (const pipe of state.pipes) {
                if (state.bird.x < pipe.top.x + gameConfig.PIPE_WIDTH &&
                    state.bird.x + state.bird.width > pipe.top.x &&
                    (state.bird.y < pipe.top.height || state.bird.y + state.bird.height > pipe.bottom.y)) {
                    return true;
                }
            }
            return false;
        }

        function addPipe() {
            const baseY = Math.random() * (canvas.height - state.gap - 200) + 100;
            state.pipes.push({
                top: { x: canvas.width, height: baseY },
                bottom: { x: canvas.width, y: baseY + state.gap },
                passed: false,
                baseY: baseY,
                offsetY: 0,
                direction: Math.random() < 0.5 ? 1 : -1
            });
        }
        
        function updateCoins() {
            const threshold = { easy: 15, medium: 10, hard: 5 }[state.currentDifficulty];
            if (state.score > 0 && state.score % threshold === 0) {
                state.coinsEarned++;
            }
        }

        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò UI ---
        function hideAllPanels() {
            Object.values(dom).forEach(panel => {
                if (panel.classList && panel.classList.contains('panel')) {
                    panel.style.display = 'none';
                }
            });
        }
        
        function updateCoinDisplay() {
            document.getElementById('coinDisplay').innerHTML = `${playerProgress.totalCoins} üí∞`;
        }
        
        function generateShopItems(tabId, count, type) {
            const grid = document.querySelector(`#${tabId} .shop-grid`);
            grid.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const isUnlocked = playerProgress[type === 'bird' ? 'unlockedBirds' : 'unlockedBackgrounds'].includes(i);
                const cost = isUnlocked ? 0 : 100; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞
                const item = document.createElement('div');
                item.className = 'shop-item';
                item.dataset.index = i;
                item.dataset.cost = cost;
                
                const img = new Image();
                img.src = isUnlocked ? (type === 'bird' ? birdImages[i].src : backgroundImages[i].src) : 'https://i.imgur.com/8dbIEzC.png'; // Question mark icon
                
                const p = document.createElement('p');
                p.innerHTML = isUnlocked ? '–í—ã–±—Ä–∞—Ç—å' : `${cost} <span class="coin-icon">üí∞</span>`;
                
                if (isUnlocked && i === playerProgress[type === 'bird' ? 'selectedBirdIndex' : 'selectedBackgroundIndex']) {
                    p.textContent = '‚úî';
                    item.classList.add('selected');
                }
                
                if (!isUnlocked) {
                    item.classList.add('locked');
                }

                item.appendChild(img);
                item.appendChild(p);
                grid.appendChild(item);
            }
        }
        
        function handleShopSelection(e) {
            const item = e.target.closest('.shop-item');
            if (!item) return;
            
            const index = parseInt(item.dataset.index);
            let cost = parseInt(item.dataset.cost);
            const type = item.closest('.tab-content').id === 'birdsTab' ? 'bird' : 'background';
            const progressKey = type === 'bird' ? 'unlockedBirds' : 'unlockedBackgrounds';
            
            if (cost > 0) { // –ü–æ–∫—É–ø–∫–∞
                if (playerProgress.totalCoins >= cost) {
                    playerProgress.totalCoins -= cost;
                    playerProgress[progressKey].push(index);
                    item.dataset.cost = 0;
                    item.classList.remove('locked');
                    item.querySelector('img').src = type === 'bird' ? birdImages[index].src : backgroundImages[index].src;
                    saveGameProgress();
                    updateCoinDisplay();
                } else {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
                    return;
                }
            }
            
            // –í—ã–±–æ—Ä
            const selectedKey = type === 'bird' ? 'selectedBirdIndex' : 'selectedBackgroundIndex';
            playerProgress[selectedKey] = index;
            document.querySelectorAll(`#${type === 'bird' ? 'birdsTab' : 'backgroundsTab'} .shop-item`).forEach(el => {
                el.classList.remove('selected');
                const elIndex = parseInt(el.dataset.index);
                if (playerProgress[progressKey].includes(elIndex)) {
                     el.querySelector('p').textContent = (elIndex === index) ? '‚úî' : '–í—ã–±—Ä–∞—Ç—å';
                }
            });
            item.classList.add('selected');
            saveGameProgress();
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô ---
        function setupUIListeners() {
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π
            document.addEventListener('keydown', e => { if (e.key === ' ' || e.key === 'ArrowUp') state.bird.velocity = birdPhysics.LIFT; });
            canvas.addEventListener('touchstart', e => { e.preventDefault(); state.bird.velocity = birdPhysics.LIFT; });
            
            // –ö–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
            document.getElementById('easyBtn').addEventListener('click', () => startGame('easy'));
            document.getElementById('mediumBtn').addEventListener('click', () => startGame('medium'));
            document.getElementById('hardBtn').addEventListener('click', () => startGame('hard'));

            // –ö–Ω–æ–ø–∫–∏ –≥–µ–π–º–æ–≤–µ—Ä–∞
            document.getElementById('restartBtn').addEventListener('click', () => startGame(state.currentDifficulty));
            document.getElementById('menuBtn').addEventListener('click', () => {
                hideAllPanels();
                dom.mainMenu.style.display = 'block';
            });
            document.getElementById('shareBtn').addEventListener('click', () => {
                 vkBridge.send('VKWebAppShare', { link: `https://vk.com/app${vkUser?.app_id || '–í–ê–®_ID'}` });
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –º–∞–≥–∞–∑–∏–Ω–∞
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.tab-button.active').classList.remove('active');
                    document.querySelector('.tab-content.active').classList.remove('active');
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
                });
            });

            // –ö–ª–∏–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –≤ –º–∞–≥–∞–∑–∏–Ω–µ
            document.getElementById('shopPanel').addEventListener('click', handleShopSelection);
            
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–∞–Ω–µ–ª—è–º
            const panelButtons = [
                { btn: 'shopBtn', open: 'shopPanel', close: 'mainMenu' }, { btn: 'statsBtn', open: 'statsPanel', close: 'mainMenu' },
                { btn: 'infoBtn', open: 'infoPanel', close: 'mainMenu' }, { btn: 'closeShopBtn', open: 'mainMenu', close: 'shopPanel' },
                { btn: 'closeStatsBtn', open: 'mainMenu', close: 'statsPanel' }, { btn: 'closeInfoBtn', open: 'mainMenu', close: 'infoPanel' },
                { btn: 'coinsBtn', open: 'coinsPanel', close: 'shopPanel' }, { btn: 'closeCoinsBtn', open: 'shopPanel', close: 'coinsPanel' }
            ];
            panelButtons.forEach(({btn, open, close}) => {
                document.getElementById(btn).addEventListener('click', () => {
                    if (close) document.getElementById(close).style.display = 'none';
                    document.getElementById(open).style.display = 'block';
                });
            });

            // –ü–æ–∫—É–ø–∫–∞ –º–æ–Ω–µ—Ç
            document.querySelectorAll('.coin-package').forEach(btn => {
                btn.addEventListener('click', () => buyCoins(btn.dataset.item));
            });
            
            // –†–µ–∫–ª–∞–º–∞ –∑–∞ –º–æ–Ω–µ—Ç—ã
            document.getElementById('earnButton').addEventListener('click', async () => {
                try {
                    const result = await vkBridge.send('VKWebAppShowRewardAd', { ad_format: 'reward' });
                    if (result.result) {
                        playerProgress.totalCoins += 100;
                        updateCoinDisplay();
                        await saveGameProgress();
                    }
                } catch (e) { console.error(e); alert('–†–µ–∫–ª–∞–º–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); }
            });
        }
        
        // --- –ó–ê–ü–£–°–ö ---
        await loadGameProgress();
        hideAllPanels();
        dom.mainMenu.style.display = 'block';
        updateCoinDisplay();
        generateShopItems('birdsTab', BIRD_COUNT, 'bird');
        generateShopItems('backgroundsTab', BACKGROUND_COUNT, 'background');
        setupUIListeners();
    });
    </script>
</body>
</html>
